#!/usr/bin/env php
<?php

if (! isset($argv[1])) {
    printf("Please provide \$argv[1] for session identifier!\n");
    exit(1);
}

use danog\MadelineProto\API;
use TelegramDaemon\EventHandler;

require __DIR__."/../config/init.php";
require __DIR__."/../config/telegramd.php";
require __DIR__."/../vendor/autoload.php";

chdir(STORAGE_PATH."/tmp");
set_include_path(STORAGE_PATH."/tmp");

if (!file_exists(STORAGE_PATH."/tmp/madeline.php")) {
    copy("https://phar.madelineproto.xyz/madeline.php", STORAGE_PATH."/tmp/madeline.php");
}

if (!defined("DEBUG_MODE")) {
    define("DEBUG_MODE", true);
}

require STORAGE_PATH."/tmp/madeline.php";

$madelineProto = new API(STORAGE_PATH."/telegram_sessions/".$argv[1]);
$madelineProto->start();

$madelineProto->setEventHandler(
	EventHandler::class
);
$madelineProto->loop(-1);
